# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Unity CI/CD for Gwangju Run

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-deploy-android:
    name: Build & Deploy Android ğŸš€
    runs-on: ubuntu-latest

    steps:
    # 1. ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (Checkout)
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    # 2. Git LFS íŒŒì¼ ë‹¤ìš´ë¡œë“œ (LFS ì‚¬ìš© ì‹œ)
    - name: Pull Git LFS files
      run: git lfs pull

    # 3. Setup Unity Editor (buildalon)
    - name: Setup Unity Editor (buildalon)
      uses: buildalon/unity-setup@v1.0.0 # ì˜ˆì‹œ ë²„ì „, ìµœì‹  ì•ˆì • ë²„ì „ í™•ì¸ í•„ìš”
      with:
        unity-version: 6000.0.42f1

    # 4. Activate Unity License (buildalon)
    - name: Activate Unity License (buildalon)
      uses: buildalon/activate-unity-license@v1.0.6 # ë³´ê³ ì„œ ì–¸ê¸‰ ë²„ì „
      with:
        unity-username: ${{ secrets.UNITY_USERNAME }}
        unity-password: ${{ secrets.UNITY_PASSWORD }}
        # unity-serial: ${{ secrets.UNITY_SERIAL }} # Pro/Plusì¸ ê²½ìš°
        # TFA ì§€ì› ì—¬ë¶€ í™•ì¸ í•„ìš”, ì§€ì› ì‹œ ê´€ë ¨ ì…ë ¥ ì¶”ê°€

    # 5. Build Unity Project (buildalon)
    - name: Build Unity Project (Android - buildalon)
      uses: buildalon/unity-action@v1.0.0 # ì˜ˆì‹œ ë²„ì „, ìµœì‹  ì•ˆì • ë²„ì „ í™•ì¸ í•„ìš”
      id: build-android
      with:
        project-path: . # Unity í”„ë¡œì íŠ¸ ê²½ë¡œ (ë£¨íŠ¸ì´ë¯€ë¡œ .)
        target-platform: Android
        # ì¶”ê°€ì ì¸ ë¹Œë“œ ì˜µì…˜ì€ buildalon/unity-action ë¬¸ì„œ ì°¸ì¡°

    # 6. AWS ìê²© ì¦ëª… ì„¤ì •
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      # ... (ì´ì „ê³¼ ë™ì¼) ...

    # 7. ë¹Œë“œ ê²°ê³¼ë¬¼ S3ì— ì—…ë¡œë“œ
    - name: Upload Android Build to S3
      run: |
        # buildalon/unity-actionì˜ outputs.artifactsPathë¥¼ í™•ì¸í•´ì•¼ í•¨
        # ì•„ë˜ëŠ” game-ci/unity-builder ê¸°ì¤€ì´ë¯€ë¡œ, buildalonì— ë§ê²Œ ìˆ˜ì • í•„ìš”
        # ì˜ˆì‹œ: if [ -d "${{ steps.build-android.outputs.artifactsPath }}/Android" ]; then
        #         aws s3 cp "${{ steps.build-android.outputs.artifactsPath }}/Android/" ...
        #       else ... fi
        echo "S3 Upload step needs adjustment for buildalon output path"
        # ì„ì‹œë¡œ ë¹Œë“œ ì„±ê³µ ì—¬ë¶€ë§Œ í™•ì¸í•˜ê¸° ìœ„í•´ ì•„ë˜ ì‹¤ì œ ì—…ë¡œë“œëŠ” ì£¼ì„ ì²˜ë¦¬
        # if [ -d "${{ steps.build-android.outputs.buildsPath }}/${{ env.UNITY_TARGET_PLATFORM }}" ]; then # ì´ ê²½ë¡œëŠ” game-ci ê¸°ì¤€
        #   aws s3 cp "${{ steps.build-android.outputs.buildsPath }}/${{ env.UNITY_TARGET_PLATFORM }}/" "s3://${{ secrets.S3_BUCKET_NAME }}/builds/android/$(date +%Y-%m-%d)-${{ github.sha }}/" --recursive --acl private
        #   echo "Build uploaded to s3://${{ secrets.S3_BUCKET_NAME }}/builds/android/$(date +%Y-%m-%d)-${{ github.sha }}/"
        # else
        #   echo "Build path not found, skipping S3 upload."
        #   exit 1
        # fi
      env:
        AWS_REGION: ${{ secrets.AWS_REGION }}

# ... (ì´í•˜ Google Play ë°°í¬ëŠ” ì£¼ì„ ì²˜ë¦¬ëœ ìƒíƒœë¡œ ìœ ì§€) ...