# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Unity CI/CD for Gwangju Run

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° (ì–¸ì œ ì‹¤í–‰ë ì§€)
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

# ì‹¤í–‰ë  ì‘ì—…ë“¤ ì •ì˜
jobs:
  # ë¹Œë“œ ë° ë°°í¬ ì‘ì—…
  build-and-deploy-android: # ì‘ì—… ID (ê³ ìœ í•´ì•¼ í•¨)
    name: Build & Deploy Android ğŸš€ # ì‘ì—… ì´ë¦„ (GitHub Actions UIì— í‘œì‹œë¨)
    runs-on: ubuntu-latest # ì‹¤í–‰ í™˜ê²½ (Ubuntu ìµœì‹  ë²„ì „)

    steps: # ì‘ì—… ë‚´ ì‹¤í–‰ ë‹¨ê³„ë“¤
    # 1. ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (Checkout)
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true # Git LFS ì‚¬ìš©í•˜ëŠ” ê²½ìš° trueë¡œ ì„¤ì •

    # 2. Git LFS íŒŒì¼ ë‹¤ìš´ë¡œë“œ (LFS ì‚¬ìš© ì‹œ)
    - name: Pull Git LFS files
      run: git lfs pull

    # 3. Setup Unity Editor (buildalon)
    - name: Setup Unity Editor (buildalon)
      uses: buildalon/unity-setup@v1.0.0 # ì¤‘ìš”: ìµœì‹  ì•ˆì • ë²„ì „ìœ¼ë¡œ í™•ì¸/êµì²´ ê¶Œì¥
      with:
        unity-version: 6000.0.42f1 # ì‚¬ìš©í•˜ëŠ” ì •í™•í•œ Unity ë²„ì „ ëª…ì‹œ!
        build-targets: Android # Android ë¹Œë“œ íƒ€ê²Ÿ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€

    # 4. Activate Unity License (buildalon)
    - name: Activate Unity License (buildalon)
      uses: buildalon/activate-unity-license@v1.0.6 # ì¤‘ìš”: ìµœì‹  ì•ˆì • ë²„ì „ìœ¼ë¡œ í™•ì¸/êµì²´ ê¶Œì¥
      with:
        unity-username: ${{ secrets.UNITY_USERNAME }}
        unity-password: ${{ secrets.UNITY_PASSWORD }}
        # TFA ì§€ì› ì—¬ë¶€ ë° ê´€ë ¨ ì…ë ¥ì€ buildalon/activate-unity-license ë¬¸ì„œì—ì„œ í™•ì¸ í•„ìš”
        # (ì˜ˆ: authenticator-key: ${{ secrets.UNITY_AUTHENTICATOR_KEY }} )

    # 5. Build Unity Project (buildalon)
    - name: Build Unity Project (Android - buildalon)
      uses: buildalon/unity-action@v1.0.0 # ì¤‘ìš”: ìµœì‹  ì•ˆì • ë²„ì „ìœ¼ë¡œ í™•ì¸/êµì²´ ê¶Œì¥
      id: build-android # ë¹Œë“œ ê²°ê³¼ë¥¼ ì°¸ì¡°í•˜ê¸° ìœ„í•œ ID
      with:
        project-path: . # Unity í”„ë¡œì íŠ¸ ê²½ë¡œ (ë£¨íŠ¸ì´ë¯€ë¡œ .)
        target-platform: Android
        # ì¶”ê°€ì ì¸ ë¹Œë“œ ì˜µì…˜ì€ buildalon/unity-action ë¬¸ì„œ ì°¸ì¡°
        # ì˜ˆ: build-name: GwangjuRun
        #     android-app-bundle: true # AAB íŒŒì¼ë¡œ ë¹Œë“œí•˜ë ¤ë©´

    # 6. AWS ìê²© ì¦ëª… ì„¤ì •
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    # 7. ë¹Œë“œ ê²°ê³¼ë¬¼ S3ì— ì—…ë¡œë“œ
    - name: Upload Android Build to S3
      run: |
        echo "Checking for build artifacts..."
        # buildalon/unity-action ì•¡ì…˜ì˜ ì¶œë ¥ ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ì—¬ ì •í™•í•œ ë¹Œë“œ ê²½ë¡œë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
        # ì•„ë˜ëŠ” ì˜ˆì‹œ ê²½ë¡œì´ë©°, ì‹¤ì œ ì¶œë ¥ ë³€ìˆ˜ ì´ë¦„ (ì˜ˆ: steps.build-android.outputs.artifactsPath)ê³¼
        # ê·¸ í•˜ìœ„ ê²½ë¡œ êµ¬ì¡°ë¥¼ buildalon ë¬¸ì„œì—ì„œ í™•ì¸í•˜ê³  ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
        BUILD_OUTPUT_PATH="${{ steps.build-android.outputs.artifactsPath }}/Android" # ì˜ˆì‹œ ê²½ë¡œ, ì‹¤ì œ buildalon ì¶œë ¥ì— ë”°ë¼ ìˆ˜ì • í•„ìš”

        if [ -d "$BUILD_OUTPUT_PATH" ] && [ "$(ls -A $BUILD_OUTPUT_PATH)" ]; then
          echo "Build artifacts found at $BUILD_OUTPUT_PATH. Uploading to S3..."
          aws s3 cp "$BUILD_OUTPUT_PATH/" "s3://${{ secrets.S3_BUCKET_NAME }}/builds/android/$(date +%Y-%m-%d)-${{ github.sha }}/" --recursive --acl private
          echo "Build uploaded to s3://${{ secrets.S3_BUCKET_NAME }}/builds/android/$(date +%Y-%m-%d)-${{ github.sha }}/"
        else
          echo "Build artifacts path '$BUILD_OUTPUT_PATH' not found or empty. Skipping S3 upload."
          echo "Listing contents of ${{ steps.build-android.outputs.artifactsPath }} (if it exists):"
          ls -R ${{ steps.build-android.outputs.artifactsPath }} || echo "artifactsPath not found or empty."
          # ë¹Œë“œ ì‹¤íŒ¨ë¡œ ê°„ì£¼í•˜ê³  ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì²˜ë¦¬ (ì„ íƒ ì‚¬í•­)
          # exit 1
        fi
      env:
        AWS_REGION: ${{ secrets.AWS_REGION }}

    # 8. (ì„ íƒ ì‚¬í•­) Google Play Store ë°°í¬
    #    - GOOGLE_PLAY_SERVICE_ACCOUNT_JSON Secret ë° ì‚¬ì „ ì„¤ì • í•„ìš”
    #    - ì•„ë˜ ë¶€ë¶„ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì£¼ì„(#)ì„ ì œê±°í•˜ê³  ì„¤ì •ì„ ë§ì¶”ì„¸ìš”.
    # - name: Deploy to Google Play Internal Testing
    #   if: github.ref == 'refs/heads/master' && success() # ì´ì „ ë‹¨ê³„ ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰
    #   uses: r0adkll/upload-google-play@v1
    #   with:
    #     serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
    #     packageName: com.yourcompany.gwangjurun # ì•±ì˜ íŒ¨í‚¤ì§€ ì´ë¦„ìœ¼ë¡œ ë³€ê²½!
    #     releaseFiles: ${{ steps.build-android.outputs.artifactsPath }}/Android/*.aab # buildalon ì¶œë ¥ ê²½ë¡œ ë° AAB íŒŒì¼ ê²½ë¡œ (APKì¸ ê²½ìš° *.apk)
    #     track: internal # ë°°í¬ íŠ¸ë™ (internal, alpha, beta, production)
    #     status: completed # ë°°í¬ ìƒíƒœ