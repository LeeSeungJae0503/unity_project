# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Unity CI/CD for Gwangju Run

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° (ì–¸ì œ ì‹¤í–‰ë ì§€)
on:
  push:
    branches: [ master ] # 'master' ë¸Œëœì¹˜ì— ì½”ë“œê°€ pushë  ë•Œ ì‹¤í–‰
  pull_request:
    branches: [ master ] # 'master' ë¸Œëœì¹˜ë¡œ Pull Requestê°€ ì—´ë¦´ ë•Œ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ ìš©ë„)

# ì‹¤í–‰ë  ì‘ì—…ë“¤ ì •ì˜
jobs:
  # ë¹Œë“œ ë° ë°°í¬ ì‘ì—…
  build-and-deploy-android: # ì‘ì—… ID (ê³ ìœ í•´ì•¼ í•¨)
    name: Build & Deploy Android ğŸš€ # ì‘ì—… ì´ë¦„ (GitHub Actions UIì— í‘œì‹œë¨)
    runs-on: ubuntu-latest # ì‹¤í–‰ í™˜ê²½ (Ubuntu ìµœì‹  ë²„ì „)

    steps: # ì‘ì—… ë‚´ ì‹¤í–‰ ë‹¨ê³„ë“¤
    # 1. ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (Checkout)
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true # Git LFS ì‚¬ìš©í•˜ëŠ” ê²½ìš° trueë¡œ ì„¤ì •

    # 2. Git LFS íŒŒì¼ ë‹¤ìš´ë¡œë“œ (LFS ì‚¬ìš© ì‹œ)
    - name: Pull Git LFS files
      run: git lfs pull

    # 3. Unity ë¼ì´ì„ ìŠ¤ í™œì„±í™” (kuler90/activate-unity ì•¡ì…˜ ì‚¬ìš©)
    - name: Activate Unity License (kuler90)
      uses: kuler90/activate-unity@v1.1.3 # ì‚¬ìš©ìë‹˜ì˜ ë¦¬ì„œì¹˜ì—ì„œ ì–¸ê¸‰ëœ ë²„ì „ ì‚¬ìš©
      with:
        unity-username: ${{ secrets.UNITY_USERNAME }}
        unity-password: ${{ secrets.UNITY_PASSWORD }}
        unity-authenticator-key: ${{ secrets.UNITY_AUTHENTICATOR_KEY }} # 2FA ì‚¬ìš©í•˜ëŠ” ê²½ìš°

    # 4. Unity í”„ë¡œì íŠ¸ ë¹Œë“œ (Android)
    - name: Build Unity Project (Android)
      uses: game-ci/unity-builder@v4
      id: build-android # ë¹Œë“œ ê²°ê³¼ë¥¼ ì°¸ì¡°í•˜ê¸° ìœ„í•œ ID
      env: # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ë¹Œë“œ íƒ€ê²Ÿ ì§€ì • ë“±)
        UNITY_TARGET_PLATFORM: Android
      with:
        unityVersion: 6000.0.42f1 # ì‚¬ìš©í•˜ëŠ” ì •í™•í•œ Unity ë²„ì „ ëª…ì‹œ!
        targetPlatform: ${{ env.UNITY_TARGET_PLATFORM }}
        # androidAppBundle: true # AAB íŒŒì¼ë¡œ ë¹Œë“œí•˜ë ¤ë©´ ì£¼ì„ í•´ì œ (Google Play ê¶Œì¥)
        # buildName: GwangjuRun # ë¹Œë“œ íŒŒì¼ ì´ë¦„ (ì„ íƒ ì‚¬í•­)

    # 5. AWS ìê²© ì¦ëª… ì„¤ì •
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    # 6. ë¹Œë“œ ê²°ê³¼ë¬¼(APK ë˜ëŠ” AAB) S3ì— ì—…ë¡œë“œ
    - name: Upload Android Build to S3
      # build-android ë‹¨ê³„ê°€ ì‹¤íŒ¨í•´ë„ S3 ì—…ë¡œë“œë¥¼ ì‹œë„í•˜ì§€ ì•Šë„ë¡ ì¡°ê±´ ì¶”ê°€ (ì„ íƒ ì‚¬í•­)
      # if: success() || failure() # í•„ìš”ì— ë”°ë¼ ì¡°ê±´ ì¡°ì •
      run: |
        # ë¹Œë“œ ë‹¨ê³„ì—ì„œ ìƒì„±ëœ ê²½ë¡œê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (ì˜¤ë¥˜ ë°©ì§€)
        if [ -d "${{ steps.build-android.outputs.buildsPath }}/${{ env.UNITY_TARGET_PLATFORM }}" ]; then
          aws s3 cp "${{ steps.build-android.outputs.buildsPath }}/${{ env.UNITY_TARGET_PLATFORM }}/" "s3://${{ secrets.S3_BUCKET_NAME }}/builds/android/$(date +%Y-%m-%d)-${{ github.sha }}/" --recursive --acl private
          echo "Build uploaded to s3://${{ secrets.S3_BUCKET_NAME }}/builds/android/$(date +%Y-%m-%d)-${{ github.sha }}/"
        else
          echo "Build path not found, skipping S3 upload."
          # ë¹Œë“œê°€ ì‹¤íŒ¨í–ˆìŒì„ ëª…ì‹œì ìœ¼ë¡œ ì•Œë¦¬ê³  ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì²˜ë¦¬ (ì„ íƒ ì‚¬í•­)
          # exit 1
        fi
      env:
         AWS_REGION: ${{ secrets.AWS_REGION }} # ëª…ì‹œì ìœ¼ë¡œ ë¦¬ì „ ì „ë‹¬

    # 7. (ì„ íƒ ì‚¬í•­) Google Play Store ë°°í¬
    #    - GOOGLE_PLAY_SERVICE_ACCOUNT_JSON Secret ë° ì‚¬ì „ ì„¤ì • í•„ìš”
    #    - ì•„ë˜ ë¶€ë¶„ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì£¼ì„(#)ì„ ì œê±°í•˜ê³  ì„¤ì •ì„ ë§ì¶”ì„¸ìš”.
    # - name: Deploy to Google Play Internal Testing
    #   if: github.ref == 'refs/heads/master' && success() # ì´ì „ ë‹¨ê³„ ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰
    #   uses: r0adkll/upload-google-play@v1
    #   with:
    #     serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
    #     packageName: com.yourcompany.gwangjurun # ì•±ì˜ íŒ¨í‚¤ì§€ ì´ë¦„ìœ¼ë¡œ ë³€ê²½!
    #     releaseFiles: ${{ steps.build-android.outputs.buildsPath }}/${{ env.UNITY_TARGET_PLATFORM }}/*.aab # AAB íŒŒì¼ ê²½ë¡œ (APKì¸ ê²½ìš° *.apk)
    #     track: internal # ë°°í¬ íŠ¸ë™ (internal, alpha, beta, production)
    #     status: completed # ë°°í¬ ìƒíƒœ